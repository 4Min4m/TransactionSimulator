# buildspec-lambda-package.yml
version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20 # Ensure this matches your lambda runtime
    commands:
      - echo "Installing dependencies for Lambda function..."
      - cd lambda
      - npm install
      - echo "Dependencies installed."

  build:
    commands:
      - echo "Zipping Lambda function code..."
      - zip -r ../lambda.zip .
      - echo "Lambda code zipped."

      # --- START OF MODIFICATION ---
      # Fetch AWS Account ID dynamically using AWS CLI
      - export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
      # --- END OF MODIFICATION ---

      # Define the S3 bucket name dynamically based on the Terraform definition
      # It's crucial this matches the bucket name generated by Terraform.
      # Format: transaction-simulator-lambda-code-${ACCOUNT_ID}-${AWS_REGION}
      - export LAMBDA_CODE_S3_BUCKET="transaction-simulator-lambda-code-${AWS_ACCOUNT_ID}-${AWS_DEFAULT_REGION}"
      - echo "Lambda S3 Bucket $LAMBDA_CODE_S3_BUCKET"

      # Define a unique S3 key for this Lambda package using the short commit hash
      - export LAMBDA_S3_KEY="lambda-packages/lambda-${CODEBUILD_RESOLVED_SOURCE_VERSION}.zip"
      - echo "Lambda S3 Key $LAMBDA_S3_KEY"

      - echo "Uploading lambda.zip to S3..."
      # Upload the zipped file to the S3 bucket
      # --metadata-directive REPLACE ensures metadata is set correctly on re-upload
      - aws s3 cp ../lambda.zip "s3://${LAMBDA_CODE_S3_BUCKET}/${LAMBDA_S3_KEY}" --metadata-directive REPLACE --acl bucket-owner-full-control --sse AES256
      - echo "Lambda.zip uploaded to S3."

      # Create a build.env file to pass variables to downstream CodeBuild projects
      - echo "LAMBDA_S3_BUCKET=$LAMBDA_CODE_S3_BUCKET" > build.env
      - echo "LAMBDA_S3_KEY=$LAMBDA_S3_KEY" >> build.env
      - echo "build.env file created with S3 location details."

  post_build:
    commands:
      - echo "Lambda packaging and upload completed."
      - ls -la build.env # Verify build.env exists and contains info

artifacts:
  files:
    - lambda.zip
  discard-paths: yes
  name: LambdaArtifact

  secondary-artifacts:
    LambdaS3LocationArtifact:
      files:
        - build.env
      discard-paths: yes