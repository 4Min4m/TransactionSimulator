# buildspec-smoke-tests.yml
# This buildspec runs automated tests against the deployed application (API Gateway and Frontend).
# This file will be placed in the root of your 'my-payment-simulator' repository.
version: 0.2

phases:
  install:
    commands:
      # Install curl and jq for making HTTP requests and parsing JSON outputs.
      - echo "Installing curl and jq for smoke tests..."
      - sudo apt-get update -y
      - sudo apt-get install -y curl jq

  build:
    commands:
      - echo "Running smoke tests..."
      # Extract API Gateway and Frontend URLs from the 'terraform_outputs.json' artifact.
      # This file is generated by the 'Terraform Apply' stage.
      - API_URL=$(jq -r '.api_gateway_invoke_url.value' terraform_outputs.json)
      - FRONTEND_URL=$(jq -r '.frontend_website_url.value' terraform_outputs.json)

      # Basic validation to ensure URLs are not empty before testing.
      - if [ -z "$API_URL" ]; then echo "ERROR API_URL is empty. Cannot run API tests."; exit 1; fi
      - if [ -z "$FRONTEND_URL" ]; then echo "ERROR FRONTEND_URL is empty. Cannot run Frontend tests."; exit 1; fi

      - echo "Testing API Gateway URL $API_URL"
      # Perform a basic health check on the API login endpoint.
      # '--fail' will cause curl to exit with an error code if the HTTP status is >= 400.
      - curl -v --fail "$API_URL/api/login"
      - echo "API Gateway smoke test passed."

      - echo "Testing Frontend URL $FRONTEND_URL"
      # Check if the frontend is accessible by making a request to its root URL.
      - curl -v --fail "$FRONTEND_URL"
      - echo "Frontend smoke test passed."

  post_build:
    commands:
      - echo "Smoke tests completed successfully."

artifacts:
  files: [] # No specific artifacts needed from this final testing stage.